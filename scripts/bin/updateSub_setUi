#! /usr/bin/env bash

ClashConf=$HOME/.config/clash/

url=${1:-"https://raw.githubusercontent.com/yu-steven/openit/main/Clash.yaml"}

red=$'\e[31m'
cyan=$'\e[36m'
x=$'\e[0m'

if [ ! -d "${ClashConf}/clash-dashboard" ]; then
  printf "run %sgit clone -b gh-pages git@github.com:Dreamacro/clash-dashboard.git ~/.config/clash/clash-dashboard%s to install the clash web ui.\n" "$cyan" "$x"
else
  wget -q "$url" -O "${ClashConf}/config_new.yaml"
  sed -i -e "s@\(^external-controller:.*\)@\1\nexternal-ui: $HOME/.config/clash/clash-dashboard@g" "${ClashConf}/config_new.yaml"

  if ! clash -t -f "${ClashConf}/config_new.yaml" > /dev/null 2>&1; then
    rm "${ClashConf}/config_new.yaml"
    printf "%sERROR: The new config file has an error, then do nothing.%s\n" "$red" "$x"
    exit
  fi

  mv -f "${ClashConf}/config_new.yaml" "${ClashConf}/config.yaml"
  systemctl --user restart clash.service
  systemctl --user status clash.service
fi
