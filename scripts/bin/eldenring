#!/usr/bin/env bash

eldenring_dir="$HOME/Downloads/SteamLibrary/steamapps/compatdata/1245620/pfx/drive_c/users/steamuser/AppData/Roaming/EldenRing"
backup_dir="$HOME/Downloads/Resources/eldenring_backup"

main() {
  case "$1" in
    b | backup) backup ;;
    r | recovery) recovery ;;
    recount) recount ;;
    number) cat "$backup_dir/number" ;;
    recover_temp) recover_temp ;;
    delete) delete ;;
    *)  help ;;
  esac
}

help() {
  echo "b|backup"
  echo "r|recovery"
  echo "recount"
  echo "number"
  echo "recover_temp"
  echo "delete"
}

backup() {
  number=$(cat "$backup_dir/number")
  cp -r "$eldenring_dir/" "$backup_dir/backup/$number/"
  number=$(("$number" + 1))
  echo "$number" > "$backup_dir/number"
}

recount() {
  echo "0" > "$backup_dir/number"
}

recovery() {
  recovery_dir=$(ls -1 "$backup_dir/backup" | sort -nr | dmenu -l 30)
  test -n "$recovery_dir" || return
  rm -rf "$backup_dir/temp/"
  cp -r "$eldenring_dir/" "$backup_dir/temp/"
  cp -r "$backup_dir/backup/$recovery_dir"/* "$eldenring_dir/"
}

recover_temp() {
  cp -r "$backup_dir/temp"/* "$eldenring_dir/"
}

delete() {
  number=$(ls -1 "$backup_dir/backup" | sort -n | dmenu -l 30)
  test -n "$number" || return
  while [[ "$number" -ge 0 ]]; do
    rm -rf "$backup_dir/backup/$number"
    number=$(("$number" - 1))
  done
}

main "$1"
